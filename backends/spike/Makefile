###############################################################################
#                    SPIKE BACKEND - FULL AUTOMATIC MAKEFILE
###############################################################################

CC          := riscv64-unknown-elf-gcc
SPIKE_BIN   := $(HOME)/ara2/install/riscv-isa-sim-mod/bin/spike
PK          := $(HOME)/RISC-V/rv64/pk/riscv64-unknown-elf/bin/pk

KERNEL      ?= fmatmul
VLEN        ?= 256
MARCH       := rv64gcv_zicsr_zicntr
ABI         := lp64

# Arguments passed to the benchmark at runtime
ARGS ?=

###############################################################################
# PATHS
###############################################################################

KERNEL_DIR      := ../../kernel/$(KERNEL)
COMMON_DIR      := ../../kernel/common
DATA_DIR        := ../../data/$(KERNEL)

OPENBLAS_DIR      := ../../benchmarks/openblas/kernel/riscv64
OPENBLAS_MAIN_DIR := ../../benchmarks/openblas_mains

RIVEC_DIR         := ../../benchmarks/rivec

TEMPLATE          := ../../benchmarks/autogen_main_template.in
AUTOGEN_DIR       := build/autogenerated
$(shell mkdir -p $(AUTOGEN_DIR))

###############################################################################
# FLAGS
###############################################################################

CFLAGS := -O2 -march=$(MARCH) -mabi=$(ABI) -DSPIKEGEM -I$(COMMON_DIR)

###############################################################################
# PRECOMPUTE VARIABLES
###############################################################################

RIVEC_MAIN_NAME := $(patsubst _%,%,$(KERNEL))

###############################################################################
# KERNEL / BENCHMARK SELECTION LOGIC
###############################################################################

ifeq ($(wildcard ../../kernel/$(KERNEL)),)

    ###########################################################################
    #                                OPENBLAS
    ###########################################################################
    ifneq ($(wildcard $(OPENBLAS_DIR)/$(KERNEL).c),)

        BENCH_SRC := $(OPENBLAS_DIR)/$(KERNEL).c

        ifneq ($(wildcard $(OPENBLAS_MAIN_DIR)/$(KERNEL)_main.c),)
            AUTOGEN_MAIN := $(OPENBLAS_MAIN_DIR)/$(KERNEL)_main.c
        else
            AUTOGEN_MAIN := $(AUTOGEN_DIR)/$(KERNEL)_main.c
        endif

        SRCS   := $(BENCH_SRC) $(AUTOGEN_MAIN) $(COMMON_DIR)/util.c
        TARGET := build/$(KERNEL).elf

        CFLAGS += -DOS_EMBEDDED=1 -DNO_SYSV_IPC=1 -DSMP=0 -DUSE_LOCKING=0 \
                  -DARCH_RISCV64=1 -DRISCV64_ZVL256B=1 -DSPIKEGEM
        CFLAGS += -I$(COMMON_DIR)

        OPENBLAS_INC := $(shell find ../../benchmarks/openblas -type d)
        CFLAGS += $(foreach d,$(OPENBLAS_INC),-I$d)

    ###########################################################################
    #                                RIVEC
    ###########################################################################
    else ifneq ($(wildcard $(RIVEC_DIR)/$(KERNEL)),)

        BENCH_DIR := $(RIVEC_DIR)/$(KERNEL)

        # ================= SPECIAL CASE: lavaMD ==============================
        ifeq ($(KERNEL),_lavaMD)

            SRCS := \
                $(BENCH_DIR)/main.c \
                $(BENCH_DIR)/kernel/kernel_vector.c \
                $(wildcard $(BENCH_DIR)/util/*.c) \
                $(wildcard $(BENCH_DIR)/util/*.C) \
                $(wildcard $(BENCH_DIR)/util/num/*.c)

            CFLAGS += -I$(BENCH_DIR) \
                  -I$(BENCH_DIR)/src \
                  -I$(BENCH_DIR)/kernel \
                  -I$(BENCH_DIR)/util 
            CFLAGS += -DUSE_RISCV_VECTOR

        # ================= GENERIC RIVEC BENCHMARKS ==========================
        else

            SRCS := \
                $(wildcard $(BENCH_DIR)/*.c) \
                $(wildcard $(BENCH_DIR)/*.cpp) \
                $(wildcard $(BENCH_DIR)/src/*.c) \
                $(wildcard $(BENCH_DIR)/src/*.cpp) \
                $(wildcard $(BENCH_DIR)/kernel/*.c) \
                $(wildcard $(BENCH_DIR)/kernel/*.cpp) \
                $(wildcard $(BENCH_DIR)/util/*.c) \
                $(wildcard $(BENCH_DIR)/util/*.cpp) \
                $(wildcard $(BENCH_DIR)/util/num/*.c)

            CFLAGS += -I$(BENCH_DIR) \
                  -I$(BENCH_DIR)/src \
                  -I$(BENCH_DIR)/kernel \
                  -I$(BENCH_DIR)/util 

        endif

        # File main: root or src
        MAIN_FILE := $(wildcard \
            $(BENCH_DIR)/$(RIVEC_MAIN_NAME).c \
            $(BENCH_DIR)/$(RIVEC_MAIN_NAME).cpp \
            $(BENCH_DIR)/src/$(RIVEC_MAIN_NAME).c \
            $(BENCH_DIR)/src/$(RIVEC_MAIN_NAME).cpp \
            $(BENCH_DIR)/main.c)

        # If main is missing â†’ autogenerate
        ifeq ($(strip $(MAIN_FILE)),)
            AUTOGEN_MAIN := $(AUTOGEN_DIR)/$(KERNEL)_main.c
            SRCS += $(AUTOGEN_MAIN)
        endif

        TARGET := build/$(KERNEL).elf

    ###########################################################################
    # No kernel found
    ###########################################################################
    else
        $(error Invalid KERNEL '$(KERNEL)')
    endif

###############################################################################
#                           YOUR OWN KERNELS
###############################################################################
else

    TARGET := $(KERNEL_DIR)/main.elf
    SRCS := $(wildcard $(KERNEL_DIR)/*.c) \
            $(wildcard $(KERNEL_DIR)/src/*.c) \
            $(COMMON_DIR)/util.c \
            $(DATA_DIR)/dataset.c

    CFLAGS += -I$(KERNEL_DIR)/inc -I$(DATA_DIR)

endif

###############################################################################
# AUTOGENERATION OF MAIN
###############################################################################

$(AUTOGEN_DIR)/%_main.c: $(TEMPLATE)
	@echo "[AUTO] Generating benchmark main() for $* ..."
	@sed 's/FUNC_NAME/$*/g' $(TEMPLATE) > $@

###############################################################################
# BUILD
###############################################################################

build: $(TARGET)

$(TARGET): $(SRCS)
	@echo "[SPIKE] Compiling $(KERNEL)..."
	$(CC) $(CFLAGS) -o $@ $^ -lm

###############################################################################
# RUN
###############################################################################

run: $(TARGET)
	@touch out.txt
	@echo "[SPIKE] Running $(KERNEL) on Spike..."
	$(SPIKE_BIN) --isa=$(MARCH) --varch="vlen:$(VLEN),elen:64" \
	    $(PK) $(TARGET) $(ARGS)

###############################################################################
# CLEAN
###############################################################################

clean:
	rm -rf build/*.elf $(AUTOGEN_DIR)/*.c
