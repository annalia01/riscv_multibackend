###############################################################################
#                    SPIKE BACKEND - FULL AUTOMATIC MAKEFILE
###############################################################################

CC          := riscv64-unknown-elf-gcc
SPIKE_BIN   := $(HOME)/ara2/install/riscv-isa-sim-mod/bin/spike
PK          := $(HOME)/RISC-V/rv64/pk/riscv64-unknown-elf/bin/pk

KERNEL      ?= fmatmul
VLEN        ?= 256
MARCH       := rv64gcv_zicsr_zicntr
ABI         := lp64

###############################################################################
# PATHS
###############################################################################

# tuoi kernel
KERNEL_DIR      := ../../kernel/$(KERNEL)
COMMON_DIR      := ../../kernel/common
DATA_DIR        := ../../data/$(KERNEL)

# openblas (SUBMODULE → NON TOCCARE QUI)
OPENBLAS_DIR      := ../../benchmarks/openblas/kernel/riscv64
# mains personalizzati openblas
OPENBLAS_MAIN_DIR := ../../benchmarks/openblas_mains

# rivec
RIVEC_DIR         := ../../benchmarks/rivec

# autogenerazione main()
TEMPLATE          := ../../benchmarks/autogen_main_template.in
AUTOGEN_DIR       := build/autogenerated
$(shell mkdir -p $(AUTOGEN_DIR))

###############################################################################
# FLAGS
###############################################################################

CFLAGS := -O2 -march=$(MARCH) -mabi=$(ABI) -DSPIKEGEM \
          -I$(COMMON_DIR)

###############################################################################
# KERNEL / BENCHMARK SELECTION LOGIC
###############################################################################
# Se NON è un tuo kernel → OpenBLAS o RIVEC
ifeq ($(wildcard ../../kernel/$(KERNEL)),)

    ###########################################################################
    #                               OPENBLAS
    ###########################################################################
    ifneq ($(wildcard $(OPENBLAS_DIR)/$(KERNEL).c),)

        BENCH_SRC := $(OPENBLAS_DIR)/$(KERNEL).c

        # Se esiste main personalizzato → usalo
        ifneq ($(wildcard $(OPENBLAS_MAIN_DIR)/$(KERNEL)_main.c),)
            AUTOGEN_MAIN := $(OPENBLAS_MAIN_DIR)/$(KERNEL)_main.c
        else
            AUTOGEN_MAIN := $(AUTOGEN_DIR)/$(KERNEL)_main.c
        endif

        SRCS   := $(BENCH_SRC) $(AUTOGEN_MAIN) $(COMMON_DIR)/util.c
        TARGET := build/$(KERNEL).elf

        # Macro richieste da OpenBLAS
        CFLAGS += -DOS_EMBEDDED=1 -DNO_SYSV_IPC=1 -DSMP=0 -DUSE_LOCKING=0 \
                  -DARCH_RISCV64=1 -DRISCV64_ZVL256B=1 -DSPIKEGEM
	CFLAGS += -I$(COMMON_DIR)
        # Include di TUTTE le cartelle del submodule OpenBLAS
        OPENBLAS_INC := $(shell find ../../benchmarks/openblas -type d)
        CFLAGS += $(foreach d,$(OPENBLAS_INC),-I$d)

    ###########################################################################
    #                               RIVEC
    ###########################################################################
    else ifneq ($(wildcard $(RIVEC_DIR)/$(KERNEL).c),)

        BENCH_SRC := $(RIVEC_DIR)/$(KERNEL).c
        AUTOGEN_MAIN := $(AUTOGEN_DIR)/$(KERNEL)_main.c
        SRCS := $(BENCH_SRC) $(AUTOGEN_MAIN)
        TARGET := build/$(KERNEL).elf

        CFLAGS += -I$(RIVEC_DIR)

    # Nessun kernel trovato
    else
        $(error Invalid KERNEL '$(KERNEL)'. Not found in kernel/, openblas/, or rivec/)
    endif

###############################################################################
#                     YOUR OWN KERNEL MODE
###############################################################################
else

    TARGET := $(KERNEL_DIR)/main.elf
    SRCS := $(wildcard $(KERNEL_DIR)/*.c) \
            $(wildcard $(KERNEL_DIR)/src/*.c) \
            $(COMMON_DIR)/util.c \
            $(DATA_DIR)/dataset.c

    CFLAGS += -I$(KERNEL_DIR)/inc -I$(DATA_DIR)

endif

###############################################################################
# AUTOGENERATION OF MAIN.C FOR BENCHMARKS
###############################################################################

$(AUTOGEN_DIR)/%_main.c: $(TEMPLATE)
	@echo "[AUTO] Generating benchmark main() for $* ..."
	@sed 's/FUNC_NAME/$*/g' $(TEMPLATE) > $@

###############################################################################
# BUILD
###############################################################################

.PHONY: build run clean

build: $(TARGET)

$(TARGET): $(SRCS)
	@echo "[SPIKE] Compiling $(KERNEL)..."
	$(CC) $(CFLAGS) -o $@ $^ -lm

###############################################################################
# RUN
###############################################################################

run: $(TARGET)
	@echo "[SPIKE] Running $(KERNEL) on Spike..."
	$(SPIKE_BIN) --isa=$(MARCH) --varch="vlen:$(VLEN),elen:64" $(PK) $(TARGET)

###############################################################################
# CLEAN
###############################################################################

clean:
	@echo "[SPIKE] Cleaning..."
	@rm -rf build/*.elf $(AUTOGEN_DIR)/*.c
